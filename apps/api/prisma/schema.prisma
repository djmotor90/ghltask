// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Organizations (Tenants)
model Organization {
  id                 String   @id @default(cuid())
  ghl_account_id     String   @unique
  ghl_sub_account_id String?
  name               String
  planType           String   @default("free")
  status             String   @default("active")
  ghl_access_token   String?
  ghl_refresh_token  String?
  ghl_token_expires  DateTime?
  settings           Json     @default("{}")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  users              User[]
  spaces             Space[]
  folders            Folder[]
  lists              List[]
  tasks              Task[]
  customFields       CustomField[]
  activityLogs       ActivityLog[]

  @@index([ghl_account_id])
  @@map("organizations")
}

// Users
model User {
  id               String   @id @default(cuid())
  organization_id  String
  ghl_user_id      String
  email            String
  full_name        String
  avatar_url       String?
  role             String   @default("member")
  is_active        Boolean  @default(true)
  last_login_at    DateTime?
  createdAt        DateTime @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  // Relations
  createdSpaces    Space[]
  createdFolders   Folder[]
  createdLists     List[]
  createdTasks     Task[]
  assignedTasks    Task[] @relation("AssignedTasks")
  comments         Comment[]
  attachments      Attachment[]
  activityLogs     ActivityLog[]
  taskAssignments  TaskAssignment[]
  assignedByTasks  TaskAssignment[] @relation("AssignedByRelation")

  @@unique([organization_id, email])
  @@index([organization_id])
  @@map("users")
}

// Spaces
model Space {
  id               String   @id @default(cuid())
  organization_id  String
  name             String
  description      String?
  color            String   @default("#5865F2")
  created_by       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  creator          User         @relation(fields: [created_by], references: [id])

  folders          Folder[]
  lists            List[]

  @@index([organization_id])
  @@map("spaces")
}

// Folders
model Folder {
  id               String   @id @default(cuid())
  space_id         String
  organization_id  String
  name             String
  description      String?
  color            String?
  position         Int      @default(0)
  created_by       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  space            Space        @relation(fields: [space_id], references: [id], onDelete: Cascade)
  creator          User         @relation(fields: [created_by], references: [id])

  lists            List[]

  @@index([space_id])
  @@index([organization_id])
  @@map("folders")
}

// Lists
model List {
  id               String   @id @default(cuid())
  folder_id        String?
  space_id         String?
  organization_id  String
  name             String
  description      String?
  status           String   @default("active")
  view_type        String   @default("list")
  color            String?
  position         Int      @default(0)
  created_by       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  folder           Folder?      @relation(fields: [folder_id], references: [id], onDelete: SetNull)
  space            Space?       @relation(fields: [space_id], references: [id], onDelete: SetNull)
  creator          User         @relation(fields: [created_by], references: [id])

  tasks            Task[]
  customFields     CustomField[]

  @@index([folder_id])
  @@index([space_id])
  @@index([organization_id])
  @@map("lists")
}

// Tasks
model Task {
  id               String   @id @default(cuid())
  organization_id  String
  list_id          String
  parent_task_id   String?
  title            String
  description      String?
  status           String   @default("open")
  priority         String   @default("normal")
  assigned_to      String?
  assigned_at      DateTime?
  start_date       DateTime?
  due_date         DateTime?
  completed_at     DateTime?
  estimated_hours  Decimal? @db.Decimal(5, 2)
  time_spent       Decimal  @default(0) @db.Decimal(8, 2)
  created_by       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  custom_fields    Json     @default("{}")
  color            String?
  archived_at      DateTime?

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  list             List         @relation(fields: [list_id], references: [id], onDelete: Cascade)
  parentTask       Task?        @relation("ParentTasks", fields: [parent_task_id], references: [id], onDelete: SetNull)
  creator          User         @relation(fields: [created_by], references: [id])
  assignee         User?        @relation("AssignedTasks", fields: [assigned_to], references: [id], onDelete: SetNull)

  // Relations
  subTasks         Task[]       @relation("ParentTasks")
  relationships    TaskRelationship[] @relation("SourceTasks")
  relatedFrom      TaskRelationship[] @relation("TargetTasks")
  subtasks         Subtask[]
  comments         Comment[]
  attachments      Attachment[]
  fieldValues      TaskFieldValue[]
  assignments      TaskAssignment[]

  @@index([organization_id])
  @@index([list_id])
  @@index([assigned_to])
  @@index([due_date])
  @@index([status])
  @@map("tasks")
}

// Task Relationships
model TaskRelationship {
  id                 String   @id @default(cuid())
  source_task_id     String
  target_task_id     String
  relationship_type  String
  createdAt          DateTime @default(now())

  sourceTask       Task @relation("SourceTasks", fields: [source_task_id], references: [id], onDelete: Cascade)
  targetTask       Task @relation("TargetTasks", fields: [target_task_id], references: [id], onDelete: Cascade)

  @@unique([source_task_id, target_task_id, relationship_type])
  @@index([source_task_id])
  @@index([target_task_id])
  @@map("task_relationships")
}

// Subtasks
model Subtask {
  id               String   @id @default(cuid())
  task_id          String
  title            String
  is_completed     Boolean  @default(false)
  position         Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  task             Task @relation(fields: [task_id], references: [id], onDelete: Cascade)

  @@index([task_id])
  @@map("subtasks")
}

// Task Assignments (Multiple assignees)
model TaskAssignment {
  id               String   @id @default(cuid())
  task_id          String
  user_id          String
  assigned_at      DateTime @default(now())
  assigned_by      String

  task             Task @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user             User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  assignedBy       User @relation("AssignedByRelation", fields: [assigned_by], references: [id])

  @@unique([task_id, user_id])
  @@index([task_id])
  @@index([user_id])
  @@map("task_assignments")
}

// Custom Fields
model CustomField {
  id               String   @id @default(cuid())
  list_id          String
  organization_id  String
  name             String
  field_type       String
  options          Json?
  formula          String?
  linked_list_id   String?
  required         Boolean  @default(false)
  position         Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  list             List         @relation(fields: [list_id], references: [id], onDelete: Cascade)

  fieldValues      TaskFieldValue[]

  @@index([list_id])
  @@index([organization_id])
  @@map("custom_fields")
}

// Task Field Values
model TaskFieldValue {
  id               String   @id @default(cuid())
  task_id          String
  field_id         String
  value            Json?
  computed_value   Json?
  updatedAt        DateTime @updatedAt

  task             Task         @relation(fields: [task_id], references: [id], onDelete: Cascade)
  field            CustomField  @relation(fields: [field_id], references: [id], onDelete: Cascade)

  @@unique([task_id, field_id])
  @@index([task_id])
  @@index([field_id])
  @@map("task_field_values")
}

// Comments
model Comment {
  id               String   @id @default(cuid())
  task_id          String
  thread_id        String?
  user_id          String
  content          String
  content_html     String?
  is_edited        Boolean  @default(false)
  edited_at        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  task             Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [user_id], references: [id], onDelete: SetNull)
  parentComment    Comment? @relation("CommentReplies", fields: [thread_id], references: [id], onDelete: SetNull)
  replies          Comment[] @relation("CommentReplies")

  attachments      Attachment[]

  @@index([task_id])
  @@index([user_id])
  @@map("comments")
}

// Attachments
model Attachment {
  id               String   @id @default(cuid())
  task_id          String
  comment_id       String?
  file_name        String
  file_size        Int
  file_type        String
  file_url         String
  uploaded_by      String
  uploaded_at      DateTime @default(now())

  task             Task     @relation(fields: [task_id], references: [id], onDelete: Cascade)
  comment          Comment? @relation(fields: [comment_id], references: [id], onDelete: SetNull)
  uploader         User     @relation(fields: [uploaded_by], references: [id], onDelete: SetNull)

  @@index([task_id])
  @@index([comment_id])
  @@map("attachments")
}

// Activity Log
model ActivityLog {
  id               String   @id @default(cuid())
  organization_id  String
  entity_type      String
  entity_id        String
  action           String
  user_id          String?
  changes          Json?
  createdAt        DateTime @default(now())

  organization     Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  user             User?        @relation(fields: [user_id], references: [id], onDelete: SetNull)

  @@index([organization_id])
  @@index([createdAt])
  @@index([entity_type, entity_id])
  @@map("activity_log")
}
